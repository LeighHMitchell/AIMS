{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if is_edit %}Edit Activity{% else %}Add New Activity{% endif %} - AIMS{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    :root {
        --sidebar-width: 250px;
        --primary-blue: #4285f4;
        --light-blue: #60a5fa;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --green-500: #10b981;
        --red-500: #ef4444;
        --blue-50: #eff6ff;
    }

    body {
        background-color: var(--gray-50);
        font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .activity-container {
        display: flex;
        min-height: calc(100vh - 76px);
        margin-top: 0;
    }

    .activity-sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid var(--gray-200);
        padding: 0;
        position: fixed;
        height: calc(100vh - 76px);
        overflow-y: auto;
        top: 76px;
        left: 0;
        z-index: 100;
    }

    .sidebar-nav {
        padding: 1.5rem 0;
    }

    .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .nav-item {
        margin: 0;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        color: var(--gray-600);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 0.875rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .nav-link i {
        width: 20px;
        margin-right: 0.75rem;
        font-size: 1rem;
    }

    .nav-link:hover {
        background: var(--gray-50);
        color: var(--gray-800);
    }

    .nav-link.active {
        background: var(--primary-blue);
        color: white;
        font-weight: 600;
    }

    .activity-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 2rem;
        max-width: calc(100vw - var(--sidebar-width));
    }

    .content-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .content-section.active {
        display: block;
    }

    .section-header {
        margin-bottom: 2rem;
    }

    .section-header h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0 0 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-header p {
        color: var(--gray-600);
        margin: 0;
        font-size: 0.875rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-label.required::after {
        content: '⚠';
        color: var(--red-500);
        margin-left: 0.5rem;
        font-size: 1rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.5;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-control::placeholder {
        color: var(--gray-400);
        font-style: italic;
    }

    textarea.form-control {
        min-height: 120px;
        resize: vertical;
        padding: 0.875rem;
        line-height: 1.6;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-row.single {
        grid-template-columns: 1fr;
    }

    .form-row .form-group {
        margin-bottom: 0;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .btn-primary {
        background-color: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .btn-primary:hover {
        background-color: #3367d6;
        border-color: #3367d6;
    }

    .btn-secondary {
        background-color: white;
        color: var(--gray-700);
        border-color: var(--gray-300);
    }

    .btn-secondary:hover {
        background-color: var(--gray-50);
        border-color: var(--gray-400);
    }

    .btn-success {
        background-color: var(--green-500);
        color: white;
        border-color: var(--green-500);
    }

    .btn-success:hover {
        background-color: #059669;
        border-color: #059669;
    }

    .section-actions {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .form-text {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
        line-height: 1.4;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .activity-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .activity-sidebar.show {
            transform: translateX(0);
        }
        
        .activity-content {
            margin-left: 0;
            max-width: 100vw;
        }
        
        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }

    /* Select2 customization */
    .select2-container--default .select2-selection--single {
        height: 48px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 46px;
        padding-left: 12px;
        color: var(--gray-700);
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px;
        right: 12px;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* Financial Summary Cards */
    .financial-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s ease;
    }

    .summary-card:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: var(--blue-50);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-blue);
        font-size: 1.25rem;
    }

    .summary-content {
        flex: 1;
    }

    .summary-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .summary-amount {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    /* Finance Tabs */
    .finance-tabs-container {
        margin-top: 2rem;
    }

    .finance-nav-tabs {
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 2rem;
    }

    .finance-nav-tabs .nav-item {
        margin-bottom: -2px;
    }

    .finance-nav-tabs .nav-link {
        border: none;
        border-radius: 8px 8px 0 0;
        color: var(--gray-600);
        font-weight: 500;
        padding: 1rem 1.5rem;
        margin-right: 0.25rem;
        transition: all 0.2s ease;
        background: transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .finance-nav-tabs .nav-link:hover {
        background-color: var(--gray-50);
        color: var(--gray-800);
        border-color: transparent;
    }

    .finance-nav-tabs .nav-link.active {
        background-color: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .finance-tab-content {
        padding: 0;
    }

    .finance-tab-content .tab-pane {
        padding: 1.5rem 0;
    }

    /* Transaction Header */
    .transaction-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 2rem;
    }

    .dropdown-menu {
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0;
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-700);
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: var(--gray-50);
        color: var(--gray-800);
    }

    /* Funds and Transactions Sections */
    .funds-section,
    .additional-funds-section,
    .transactions-section {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .funds-section h4,
    .additional-funds-section h4,
    .transactions-section h4 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
    }

    /* Tables */
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.875rem;
    }

    .table th {
        background-color: var(--gray-50);
        font-weight: 600;
        color: var(--gray-700);
    }

    .table tbody tr:hover {
        background-color: var(--gray-50);
    }

    .table .empty-state td {
        padding: 2rem;
        text-align: center;
        color: var(--gray-500);
        font-style: italic;
    }

    /* Additional Funds Placeholder */
    .additional-funds-placeholder {
        text-align: center;
        padding: 2rem;
        border: 2px dashed var(--gray-300);
        border-radius: 8px;
        background: var(--gray-50);
    }

    .additional-funds-placeholder p {
        margin-top: 1rem;
        color: var(--gray-500);
        font-size: 0.875rem;
    }

    /* Budget Section */
    .budget-section,
    .iati-section,
    .default-settings-section {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 2rem;
    }

    .budget-section h4,
    .iati-section h4,
    .default-settings-section h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
    }

    /* IATI Sync Status */
    .sync-status-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .sync-status-card h5 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
    }

    .sync-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .sync-status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: white;
        border-radius: 6px;
        border: 1px solid var(--gray-200);
    }

    .sync-status-label {
        font-weight: 500;
        color: var(--gray-600);
        font-size: 0.875rem;
    }

    .sync-status-value {
        font-weight: 600;
        color: var(--gray-800);
    }

    .sync-actions {
        display: flex;
        gap: 1rem;
    }

    /* Transaction Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-dialog {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    /* Form validation states */
    .form-group.error .form-control {
        border-color: var(--red-500);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .form-group.error .error-message {
        color: var(--red-500);
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .form-group.success .form-control {
        border-color: var(--green-500);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    /* Action buttons in tables */
    .table .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        margin-right: 0.25rem;
    }

    .table .btn:last-child {
        margin-right: 0;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .financial-summary-grid {
            grid-template-columns: 1fr;
        }

        .finance-nav-tabs {
            overflow-x: auto;
            white-space: nowrap;
        }

        .finance-nav-tabs .nav-item {
            display: inline-block;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .modal-dialog {
            width: 95%;
            margin: 1rem;
        }

        .sync-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="activity-container">
    <!-- Sidebar Navigation -->
    <div class="activity-sidebar">
        <nav class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <button type="button" class="nav-link active" data-section="general-section">
                        <i class="fas fa-info-circle"></i>
                        <span>General</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" data-section="organisations-section">
                        <i class="fas fa-building"></i>
                        <span>Organisations</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" data-section="locations-section">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Locations</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" data-section="finances-section">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Finances</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link" data-section="results-section">
                        <i class="fas fa-chart-line"></i>
                        <span>Results</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="activity-content">
        <form method="post" class="activity-form" id="activityForm">
            {% csrf_token %}
            
            <!-- General Section -->
            <div class="content-section active" id="general-section">
                <div class="section-header">
                    <h3>General Information</h3>
                    <p>Basic information about your development activity.</p>
                </div>
                
                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}" class="form-label required">Activity Title</label>
                        {{ form.title }}
                        <small class="form-text">Provide a clear, descriptive title for your activity</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Activity Description</label>
                        {{ form.description }}
                        <small class="form-text">Detailed description of the activity and its purpose</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label class="form-label">Activity Objectives</label>
                        <textarea class="form-control" placeholder="Describe the main objectives of this activity..." rows="6" name="activity_objectives"></textarea>
                        <small class="form-text">What are the main goals and objectives of this activity?</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label class="form-label">Activity Target Groups</label>
                        <textarea class="form-control" placeholder="Describe the target groups and beneficiaries..." rows="5" name="activity_target_groups"></textarea>
                        <small class="form-text">Who are the intended beneficiaries of this activity?</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.activity_status.id_for_label }}" class="form-label">Activity Status</label>
                        {{ form.activity_status }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.recipient_country.id_for_label }}" class="form-label required">Recipient Country</label>
                        {{ form.recipient_country }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date (Planned)</label>
                        {{ form.start_date }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date (Planned)</label>
                        {{ form.end_date }}
                    </div>
                </div>

                <div class="section-actions">
                    <button type="submit" name="action" value="save_draft" class="btn btn-secondary">Save Draft</button>
                    <button type="submit" name="action" value="save_and_next" class="btn btn-primary">Save and Continue</button>
                </div>
            </div>

            <!-- Organisations Section -->
            <div class="content-section" id="organisations-section">
                <div class="section-header">
                    <h3>Organisations</h3>
                    <p>Define the organizations involved in this activity.</p>
                </div>
                
                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.reporting_org.id_for_label }}" class="form-label required">Reporting Organisation</label>
                        {{ form.reporting_org }}
                        <small class="form-text">The organization reporting this activity</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.implementing_org.id_for_label }}" class="form-label">Implementing Organisation</label>
                        {{ form.implementing_org }}
                        <small class="form-text">The organization implementing this activity</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.collaboration_type.id_for_label }}" class="form-label">Collaboration Type</label>
                        {{ form.collaboration_type }}
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.contact_info.id_for_label }}" class="form-label">Contact Information</label>
                        {{ form.contact_info }}
                        <small class="form-text">Contact details for this activity</small>
                    </div>
                </div>

                <div class="section-actions">
                    <button type="submit" name="action" value="save_draft" class="btn btn-secondary">Save Draft</button>
                    <button type="submit" name="action" value="save_and_next" class="btn btn-primary">Save and Continue</button>
                </div>
            </div>

            <!-- Locations Section -->
            <div class="content-section" id="locations-section">
                <div class="section-header">
                    <h3>Locations</h3>
                    <p>Define where your activity is implemented.</p>
                </div>
                
                <div class="form-row single">
                    <div class="form-group">
                        <label class="form-label">Implementation Locations</label>
                        <textarea class="form-control" placeholder="Describe the specific locations where this activity will be implemented..." rows="4" name="implementation_locations"></textarea>
                        <small class="form-text">Provide details about the geographic areas of implementation</small>
                    </div>
                </div>

                <div class="section-actions">
                    <button type="submit" name="action" value="save_draft" class="btn btn-secondary">Save Draft</button>
                    <button type="submit" name="action" value="save_and_next" class="btn btn-primary">Save and Continue</button>
                </div>
            </div>

            <!-- Finances Section -->
            <div class="content-section" id="finances-section">
                <div class="section-header">
                    <h3>Finances</h3>
                    <p>Manage financial transactions, budgets, and funding details for this activity.</p>
                </div>

                <!-- Financial Summary Cards -->
                <div class="financial-summary-grid">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total commitment</div>
                            <div class="summary-amount" id="total-commitment">USD 0</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total incoming funds</div>
                            <div class="summary-amount" id="total-incoming">USD 0</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total spent</div>
                            <div class="summary-amount" id="total-spent">USD 0</div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tabs -->
                <div class="finance-tabs-container">
                    <ul class="nav nav-tabs finance-nav-tabs" id="financeTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                                <i class="fas fa-exchange-alt"></i>Transactions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="budgets-tab" data-bs-toggle="tab" data-bs-target="#budgets" type="button" role="tab">
                                <i class="fas fa-calculator"></i>Budgets
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="iati-sync-tab" data-bs-toggle="tab" data-bs-target="#iati-sync" type="button" role="tab">
                                <i class="fas fa-sync-alt"></i>IATI Sync
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="default-settings-tab" data-bs-toggle="tab" data-bs-target="#default-settings" type="button" role="tab">
                                <i class="fas fa-cog"></i>Default Settings
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content finance-tab-content" id="financeTabContent">
                        <!-- Transactions Tab -->
                        <div class="tab-pane fade show active" id="transactions" role="tabpanel">
                            <!-- Add Transaction Button -->
                            <div class="transaction-header">
                                <div class="dropdown">
                                    <button class="btn btn-success dropdown-toggle" type="button" id="addTransactionDropdown" data-bs-toggle="dropdown">
                                        <i class="fas fa-plus"></i> Add a transaction
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="openTransactionModal('commitment')">
                                            <i class="fas fa-dollar-sign"></i> Add a commitment
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="openTransactionModal('incoming')">
                                            <i class="fas fa-arrow-down"></i> Add incoming funds
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="openTransactionModal('outgoing')">
                                            <i class="fas fa-arrow-up"></i> Add outgoing transaction
                                        </a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Funds Allocated Section -->
                            <div class="funds-section">
                                <h4>Funds allocated to this activity</h4>
                                <div class="funds-table-container">
                                    <table class="table funds-table" id="funds-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Finance Type</th>
                                                <th>Aid Type</th>
                                                <th>Provider</th>
                                                <th>Receiver</th>
                                                <th>Amount</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="funds-table-body">
                                            <tr class="empty-state">
                                                <td colspan="7" class="text-center text-muted">No funds allocated yet. Click "Add a commitment" to get started.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="openTransactionModal('commitment')">
                                    <i class="fas fa-plus"></i> Add another commitment
                                </button>
                            </div>

                            <!-- Additional Funds Section -->
                            <div class="additional-funds-section">
                                <h4>Did you receive funds from another donor?</h4>
                                <div class="additional-funds-placeholder">
                                    <button class="btn btn-outline-secondary" onclick="openTransactionModal('incoming')">
                                        Add funds received from another donor
                                    </button>
                                    <p class="text-muted">There are no funds from another donor added to this activity</p>
                                </div>
                            </div>

                            <!-- Financial Transactions Section -->
                            <div class="transactions-section">
                                <h4>Financial Transactions</h4>
                                <div class="transactions-table-container">
                                    <table class="table transactions-table" id="transactions-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Finance Type</th>
                                                <th>Aid Type</th>
                                                <th>Provider</th>
                                                <th>Receiver</th>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactions-table-body">
                                            <tr class="empty-state">
                                                <td colspan="8" class="text-center text-muted">No transactions recorded yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="openTransactionModal('outgoing')">
                                    <i class="fas fa-plus"></i> Add another disbursement/expenditure
                                </button>
                            </div>
                        </div>

                        <!-- Budgets Tab -->
                        <div class="tab-pane fade" id="budgets" role="tabpanel">
                            <div class="budget-section">
                                <h4>Budget Planning</h4>
                                <p class="text-muted">Plan and track your activity budget by category.</p>
                                <div class="budget-table-container">
                                    <table class="table budget-table">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Planned Amount</th>
                                                <th>Actual Amount</th>
                                                <th>Variance</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="empty-state">
                                                <td colspan="5" class="text-center text-muted">No budget items added yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Budget Item
                                </button>
                            </div>
                        </div>

                        <!-- IATI Sync Tab -->
                        <div class="tab-pane fade" id="iati-sync" role="tabpanel">
                            <div class="iati-section">
                                <h4>IATI Synchronization</h4>
                                <p class="text-muted">Manage IATI data synchronization and validation for this activity.</p>
                                
                                <div class="sync-status-card">
                                    <h5>Sync Status</h5>
                                    <div class="sync-status-grid">
                                        <div class="sync-status-item">
                                            <span class="sync-status-label">Last Sync:</span>
                                            <span class="sync-status-value">Never</span>
                                        </div>
                                        <div class="sync-status-item">
                                            <span class="sync-status-label">Status:</span>
                                            <span class="sync-status-value">Not Synced</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="sync-actions">
                                    <button class="btn btn-primary">
                                        <i class="fas fa-sync-alt"></i> Sync to IATI
                                    </button>
                                    <button class="btn btn-outline-secondary">
                                        <i class="fas fa-check"></i> Validate Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Default Settings Tab -->
                        <div class="tab-pane fade" id="default-settings" role="tabpanel">
                            <div class="default-settings-section">
                                <h4>Default Financial Settings</h4>
                                <p class="text-muted">Set default values for financial transactions and classifications.</p>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="{{ form.currency.id_for_label }}" class="form-label">Default Currency</label>
                                        {{ form.currency }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.default_flow_type.id_for_label }}" class="form-label">Default Flow Type</label>
                                        {{ form.default_flow_type }}
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="{{ form.default_finance_type.id_for_label }}" class="form-label">Default Finance Type</label>
                                        {{ form.default_finance_type }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.default_aid_type.id_for_label }}" class="form-label">Default Aid Type</label>
                                        {{ form.default_aid_type }}
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="{{ form.default_tied_status.id_for_label }}" class="form-label">Default Tied Status</label>
                                        {{ form.default_tied_status }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.funding_amount.id_for_label }}" class="form-label">Initial Funding Amount</label>
                                        {{ form.funding_amount }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-actions">
                    <button type="submit" name="action" value="save_draft" class="btn btn-secondary">Save Draft</button>
                    <button type="submit" name="action" value="save_and_next" class="btn btn-primary">Save and Continue</button>
                </div>
            </div>

            <!-- Results Section -->
            <div class="content-section" id="results-section">
                <div class="section-header">
                    <h3>Results</h3>
                    <p>Expected outcomes and impact of the activity.</p>
                </div>
                
                <div class="form-row single">
                    <div class="form-group">
                        <label class="form-label">Expected Results</label>
                        <textarea class="form-control" placeholder="Describe the expected results and outcomes..." rows="6" name="expected_results"></textarea>
                        <small class="form-text">What results do you expect to achieve through this activity?</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.sector.id_for_label }}" class="form-label">Sector</label>
                        {{ form.sector }}
                        <small class="form-text">Primary sector for this activity</small>
                    </div>
                </div>

                <div class="form-row single">
                    <div class="form-group">
                        <label for="{{ form.document_link.id_for_label }}" class="form-label">Document Link</label>
                        {{ form.document_link }}
                        <small class="form-text">Link to relevant documents or resources</small>
                    </div>
                </div>

                <div class="section-actions">
                    <button type="submit" name="action" value="save_draft" class="btn btn-secondary">Save Draft</button>
                    <button type="submit" name="action" value="save_and_publish" class="btn btn-success">Save and Publish</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal" id="transactionModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Add Transaction</h3>
            <button type="button" class="modal-close" onclick="closeTransactionModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="transactionForm">
                <input type="hidden" id="transactionType" name="transaction_type">
                
                <!-- Currency and Amount Row -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Currency</label>
                        <select class="form-control" id="transactionCurrency" name="currency" required>
                            <option value="">Select currency...</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="MMK">MMK - Myanmar Kyat</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Amount</label>
                        <input type="number" class="form-control" id="transactionAmount" name="amount" 
                               placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>

                <!-- Date -->
                <div class="form-row single">
                    <div class="form-group">
                        <label class="form-label required">Date</label>
                        <input type="date" class="form-control" id="transactionDate" name="date" required>
                    </div>
                </div>

                <!-- Provider and Receiver -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Development Partner (Provider)</label>
                        <select class="form-control" id="transactionProvider" name="provider" required>
                            <option value="">Select provider...</option>
                            <option value="AFD">Agence Française de Développement</option>
                            <option value="USAID">United States Agency for International Development</option>
                            <option value="DFID">Department for International Development</option>
                            <option value="GIZ">Deutsche Gesellschaft für Internationale Zusammenarbeit</option>
                            <option value="JICA">Japan International Cooperation Agency</option>
                            <option value="World Bank">World Bank</option>
                            <option value="UN">United Nations</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Entity Receiving Funds</label>
                        <select class="form-control" id="transactionReceiver" name="receiver" required>
                            <option value="">Select receiver...</option>
                            <option value="Government Ministry">Government Ministry</option>
                            <option value="Local NGO">Local NGO</option>
                            <option value="International NGO">International NGO</option>
                            <option value="Private Sector">Private Sector</option>
                            <option value="Community Organization">Community Organization</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Aid Type and Flow Type -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Aid Type</label>
                        <select class="form-control" id="transactionAidType" name="aid_type" required>
                            <option value="">Select aid type...</option>
                            <option value="Project-type interventions">Project-type interventions</option>
                            <option value="Core support to NGOs">Core support to NGOs</option>
                            <option value="Technical assistance">Technical assistance</option>
                            <option value="Budget support">Budget support</option>
                            <option value="Debt relief">Debt relief</option>
                            <option value="Administrative costs">Administrative costs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Flow Type</label>
                        <select class="form-control" id="transactionFlowType" name="flow_type" required>
                            <option value="">Select flow type...</option>
                            <option value="ODA">Official Development Assistance</option>
                            <option value="OOF">Other Official Flows</option>
                            <option value="Private">Private Flows</option>
                            <option value="NGO">NGO Flows</option>
                        </select>
                    </div>
                </div>

                <!-- Finance Type and Tied Status -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Finance Type</label>
                        <select class="form-control" id="transactionFinanceType" name="finance_type" required>
                            <option value="">Select finance type...</option>
                            <option value="Grant">Grant</option>
                            <option value="Interest subsidy">Interest subsidy</option>
                            <option value="Reimbursable grant">Reimbursable grant</option>
                            <option value="Standard loan">Standard loan</option>
                            <option value="Concessional loan">Concessional loan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Tied Status</label>
                        <select class="form-control" id="transactionTiedStatus" name="tied_status" required>
                            <option value="">Select tied status...</option>
                            <option value="Untied">Untied</option>
                            <option value="Tied">Tied</option>
                            <option value="Partially tied">Partially tied</option>
                        </select>
                    </div>
                </div>

                <!-- Narrative Description (for disbursements and expenditures) -->
                <div class="form-row single" id="narrativeSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Narrative Description</label>
                        <textarea class="form-control" id="transactionNarrative" name="narrative" 
                                  rows="4" placeholder="Describe what this transaction is used for..."></textarea>
                        <small class="form-text">Optional description of the transaction purpose and details</small>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery (needed for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar navigation
    const sidebarLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-section');
            
            // Update active sidebar item
            sidebarLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Update active content section
            contentSections.forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        });
    });

    // Finance tabs navigation
    const financeTabLinks = document.querySelectorAll('.finance-nav-tabs .nav-link');
    const financeTabPanes = document.querySelectorAll('.finance-tab-content .tab-pane');

    financeTabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-bs-target');
            
            // Update active tab
            financeTabLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Update active tab pane
            financeTabPanes.forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            const targetPane = document.querySelector(targetId);
            if (targetPane) {
                targetPane.classList.add('show', 'active');
            }
        });
    });

    // Initialize Select2 for better dropdowns
    $(document).ready(function() {
        $('.select2').select2({
            placeholder: "Select or type to search...",
            width: '100%'
        });
        
        // Initialize select2 for form selects
        $('select.form-control, select.form-select').select2({
            placeholder: "Select an option...",
            width: '100%',
            allowClear: true
        });
    });

    // Set today's date as default for transaction date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transactionDate').value = today;
});

// Global variables for transaction management
let transactions = [];
let editingTransactionId = null;

// Transaction modal functions
function openTransactionModal(type) {
    const modal = document.getElementById('transactionModal');
    const modalTitle = document.getElementById('modalTitle');
    const transactionType = document.getElementById('transactionType');
    const narrativeSection = document.getElementById('narrativeSection');
    
    // Reset form
    document.getElementById('transactionForm').reset();
    editingTransactionId = null;
    
    // Set transaction type
    transactionType.value = type;
    
    // Update modal title and show/hide narrative section
    switch(type) {
        case 'commitment':
            modalTitle.textContent = 'Add a Commitment';
            narrativeSection.style.display = 'none';
            break;
        case 'incoming':
            modalTitle.textContent = 'Add Incoming Funds';
            narrativeSection.style.display = 'block';
            break;
        case 'outgoing':
            modalTitle.textContent = 'Add Outgoing Transaction';
            narrativeSection.style.display = 'block';
            break;
    }
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transactionDate').value = today;
    
    modal.classList.add('show');
}

function closeTransactionModal() {
    const modal = document.getElementById('transactionModal');
    modal.classList.remove('show');
    editingTransactionId = null;
}

function saveTransaction() {
    const form = document.getElementById('transactionForm');
    const formData = new FormData(form);
    
    // Validate required fields
    const requiredFields = ['currency', 'amount', 'date', 'provider', 'receiver', 'aid_type', 'flow_type', 'finance_type', 'tied_status'];
    let isValid = true;
    
    requiredFields.forEach(field => {
        const element = document.getElementById('transaction' + field.charAt(0).toUpperCase() + field.slice(1)) || 
                       document.getElementById('transaction' + field.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(''));
        if (element && !element.value.trim()) {
            element.parentElement.classList.add('error');
            isValid = false;
        } else if (element) {
            element.parentElement.classList.remove('error');
        }
    });
    
    if (!isValid) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Create transaction object
    const transaction = {
        id: editingTransactionId || Date.now(),
        type: formData.get('transaction_type'),
        currency: formData.get('currency'),
        amount: parseFloat(formData.get('amount')),
        date: formData.get('date'),
        provider: formData.get('provider'),
        receiver: formData.get('receiver'),
        aid_type: formData.get('aid_type'),
        flow_type: formData.get('flow_type'),
        finance_type: formData.get('finance_type'),
        tied_status: formData.get('tied_status'),
        narrative: formData.get('narrative') || ''
    };
    
    // Add or update transaction
    if (editingTransactionId) {
        const index = transactions.findIndex(t => t.id === editingTransactionId);
        transactions[index] = transaction;
    } else {
        transactions.push(transaction);
    }
    
    // Update tables and summaries
    updateTransactionTables();
    updateFinancialSummary();
    
    // Close modal
    closeTransactionModal();
}

function editTransaction(id) {
    const transaction = transactions.find(t => t.id === id);
    if (!transaction) return;
    
    editingTransactionId = id;
    
    // Populate form
    document.getElementById('transactionType').value = transaction.type;
    document.getElementById('transactionCurrency').value = transaction.currency;
    document.getElementById('transactionAmount').value = transaction.amount;
    document.getElementById('transactionDate').value = transaction.date;
    document.getElementById('transactionProvider').value = transaction.provider;
    document.getElementById('transactionReceiver').value = transaction.receiver;
    document.getElementById('transactionAidType').value = transaction.aid_type;
    document.getElementById('transactionFlowType').value = transaction.flow_type;
    document.getElementById('transactionFinanceType').value = transaction.finance_type;
    document.getElementById('transactionTiedStatus').value = transaction.tied_status;
    document.getElementById('transactionNarrative').value = transaction.narrative;
    
    // Open modal
    openTransactionModal(transaction.type);
}

function deleteTransaction(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        transactions = transactions.filter(t => t.id !== id);
        updateTransactionTables();
        updateFinancialSummary();
    }
}

function updateTransactionTables() {
    const fundsTableBody = document.getElementById('funds-table-body');
    const transactionsTableBody = document.getElementById('transactions-table-body');
    
    // Clear existing rows
    fundsTableBody.innerHTML = '';
    transactionsTableBody.innerHTML = '';
    
    // Filter transactions by type
    const commitments = transactions.filter(t => t.type === 'commitment');
    const incomingFunds = transactions.filter(t => t.type === 'incoming');
    const outgoingTransactions = transactions.filter(t => t.type === 'outgoing');
    
    // Populate funds table (commitments and incoming)
    const fundsTransactions = [...commitments, ...incomingFunds];
    if (fundsTransactions.length === 0) {
        fundsTableBody.innerHTML = '<tr class="empty-state"><td colspan="7" class="text-center text-muted">No funds allocated yet. Click "Add a commitment" to get started.</td></tr>';
    } else {
        fundsTransactions.forEach(transaction => {
            const row = createTransactionRow(transaction, 'funds');
            fundsTableBody.appendChild(row);
        });
    }
    
    // Populate transactions table (all outgoing transactions)
    if (outgoingTransactions.length === 0) {
        transactionsTableBody.innerHTML = '<tr class="empty-state"><td colspan="8" class="text-center text-muted">No transactions recorded yet</td></tr>';
    } else {
        outgoingTransactions.forEach(transaction => {
            const row = createTransactionRow(transaction, 'transactions');
            transactionsTableBody.appendChild(row);
        });
    }
}

function createTransactionRow(transaction, tableType) {
    const row = document.createElement('tr');
    
    const typeLabel = transaction.type === 'commitment' ? 'C' : 
                     transaction.type === 'incoming' ? 'I' : 'D';
    
    const formattedAmount = `${transaction.currency} ${transaction.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    
    if (tableType === 'funds') {
        row.innerHTML = `
            <td><span class="badge bg-primary">${typeLabel}</span></td>
            <td>${transaction.finance_type}</td>
            <td>${transaction.aid_type}</td>
            <td>${transaction.provider}</td>
            <td>${transaction.receiver}</td>
            <td>${formattedAmount}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="editTransaction(${transaction.id})">Edit</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction(${transaction.id})">Delete</button>
            </td>
        `;
    } else {
        row.innerHTML = `
            <td><span class="badge bg-success">${typeLabel}</span></td>
            <td>${transaction.finance_type}</td>
            <td>${transaction.aid_type}</td>
            <td>${transaction.provider}</td>
            <td>${transaction.receiver}</td>
            <td>${transaction.date}</td>
            <td>${formattedAmount}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="editTransaction(${transaction.id})">Edit</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteTransaction(${transaction.id})">Delete</button>
            </td>
        `;
    }
    
    return row;
}

function updateFinancialSummary() {
    const commitments = transactions.filter(t => t.type === 'commitment');
    const incoming = transactions.filter(t => t.type === 'incoming');
    const outgoing = transactions.filter(t => t.type === 'outgoing');
    
    const totalCommitment = commitments.reduce((sum, t) => sum + t.amount, 0);
    const totalIncoming = incoming.reduce((sum, t) => sum + t.amount, 0);
    const totalSpent = outgoing.reduce((sum, t) => sum + t.amount, 0);
    
    // Update summary cards (assuming USD for simplicity)
    document.getElementById('total-commitment').textContent = `USD ${totalCommitment.toLocaleString('en-US')}`;
    document.getElementById('total-incoming').textContent = `USD ${totalIncoming.toLocaleString('en-US')}`;
    document.getElementById('total-spent').textContent = `USD ${totalSpent.toLocaleString('en-US')}`;
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('transactionModal');
    if (e.target === modal) {
        closeTransactionModal();
    }
});

// Handle dropdown toggle
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-bs-toggle="dropdown"]')) {
        e.preventDefault();
        const dropdown = e.target.nextElementSibling;
        dropdown.classList.toggle('show');
    }
    
    // Close dropdowns when clicking outside
    if (!e.target.matches('[data-bs-toggle="dropdown"]')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});
</script>
{% endblock %}